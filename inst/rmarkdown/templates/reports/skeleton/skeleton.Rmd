---
title: "Reporte Automatizado de Circulación Viral"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    number_sections: true
    latex_engine: xelatex
  sansfont: Calibri Light
  html_document:
    number_sections: true
  word_document: 
    number_sections: true
header-includes:
   - \usepackage{fancyhdr}
params:
  fci_data:
    label: "Datos Fundación Cardio Infantil"
    input: file
    value: ""
  other_viruses:
    label: "Datos Otros virus"
    input: file
    value: ""
  tosferina:
    label: "Datos Tosferina"
    input: file
    value: ""
---
\selectfont

```{r setup, echo=FALSE, error=FALSE, fig.height=5, fig.width=5, warning=FALSE, include = FALSE, message= FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "cairo_pdf")
#remotes::install_github("epiverse-trace/sivirep", ref = "dev")

rm(list = ls())

library(sivirep)
library(dplyr) 
library(ggplot2)
library(reshape2)
library(scales)

source("C:/Users/geral/Documents/TRACE/labrep/R/checking_data.R", local = knitr::knit_global())
source("C:/Users/geral/Documents/TRACE/labrep/R/import_data.R", local = knitr::knit_global())
source("C:/Users/geral/Documents/TRACE/labrep/R/plotting_data.R", local = knitr::knit_global())
source("C:/Users/geral/Documents/TRACE/labrep/R/cleaning_data.R", local = knitr::knit_global())
source("C:/Users/geral/Documents/TRACE/labrep/R/utils.R", local = knitr::knit_global())
```

\pagenumbering{gobble}
\pagenumbering{arabic}

# Virus respiratorios

Durante 2022, el Laboratorio de Salud Pública (LSP) continúa apoyando la vigilancia de la infección respiratoria aguda en Bogotá, mediante el procesamiento de muestras remitidas por instituciones centinela de los eventos: Enfermedad Similar a Influenza (ESI) que son pacientes ambulatorios, de pacientes hospitalizados por Infección Respiratoria Aguda Grave (IRAG) y de IRAG inusitado que se presente en cualquier institución de la ciudad.

Las muestras previamente son procesadas por RT-PCR para SARS-CoV-2 y después continúan su análisis con: inmunofluorescencia y reacción en cadena de la polimerasa con transcriptasa inversa (RT-PCR) para el diagnóstico de los principales agentes a los que se les atribuye el IRAG.

Para esta semana, por grupo de edad, el 78.2 % de pacientes positivos para virus respiratorios diferentes al SARS-CoV-2 en 2022 corresponden a la población de menores de 5 años (figura 1) y si se incluye al SARS-CoV-2 los menores corresponden al 2.1 % (figura 2).

**Figura 1. Distribución porcentual de virus respiratorios por grupo de edad, Laboratorio de Salud Pública Bogotá.**

```{r disease_data, echo=FALSE, error=FALSE, fig.height=5, fig.width=8, warning=FALSE, include=TRUE, message=FALSE}
report_data <- import_data_viral_circulation(report_data = c("C:/Users/geral/Documents/TRACE/labrep/data/df_respiratory_filmarray_202252.csv"), header = TRUE)
report_data_clean <- cleansing_viral_circulation_data(report_data)
report_data_clean <- generate_age_categories(report_data_clean)
viruses_age_group <- get_distribution_age_group(report_data = report_data_clean)
plot_distribution_age_group(viruses_age_group)

```
\newpage

En la figura 1 se presenta el consolidado de los virus respiratorios por los diferentes grupos de edad. En los niños menores de 2 años las mayores frecuencias son de casos de virus: virus 
sincicial respiratorio (VSR) (28%), de rinovirus (23 %), y de adenovirus (21 %); para los niños entre 2 y 4 años se presentan casos de VSR (23 %), rinovirus (22 %), bocavirus (11 %) y adenovirus (23 %).

**Figura 2.Distribución porcentual de virus respiratorios y SARS CoV 2 por grupo de edad, Laboratorio de Salud Pública Bogotá. **

```{r distribution_not, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE} 

sars_data <- import_data_viral_circulation(report_data = c("C:/Users/geral/Documents/TRACE/labrep/data/df_other_virus_202252.csv"), header = TRUE)
sars_age_group <- get_distribution_age_group_sars(sars_data)
sars_viruses_age_group <- get_distribution_age_vr_sars(viruses_age_group, sars_age_group)
plot_distribution_age_group(sars_viruses_age_group, var_y = "casos", include_sars = TRUE)
```
\pagenumbering{arabic}

Al incluir el virus de SARS-CoV-2 en la cuenta de los virus respiratorios, se observa que, en 
los menores de 2 años predomina el SARS-CoV-2 (25 %), VSR (21 %), rinovirus (17 %). En el grupo de 2 a 4 años, SARS-CoV-2 (17 %), VSR (19 %), rinovirus (18 %), bocavirus y adenovirus (9 %) y (19 %) respectivamente. A continuación, se presenta la circulación acumulada de los virus respiratorios de forma desagregada por tipo de vigilancia, según grupo de edad (figura 3). También se ha incluido al SARS-CoV-2.

\newpage

**Figura 3. Circulación de virus respiratorios por tipo de vigilancia y según grupo de edad, Laboratorio de Salud Pública. **

**Distribución de virus respiratorios en casos de ESI, según grupos de edad. Bogotá**

```{r distribution_cg, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
data_other_viruses <- clean_data_other_viruses(sars_data)
esi_distribution_age <- get_distribution_surveillance(data_other_viruses,
                              include_sars = TRUE,
                              surveillance_type = "esi")
plot_distribution_age_group(esi_distribution_age, include_sars = TRUE)
```

**Distribución de virus respiratorios en casos de IRA Grave, según grupos de edad. Bogotá**

```{r distribution_epiweek, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
irag_grave_distribution_age <- get_distribution_surveillance(data_other_viruses,
                              include_sars = TRUE,
                              surveillance_type = "irag_grave")
plot_distribution_age_group(irag_grave_distribution_age, include_sars = TRUE) 
```

\newpage

**Distribución de virus respiratorios en casos de IRAG Inusitado, según grupos de edad. Bogotá**

```{r distribution_age_d, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
irag_inusitado_distribution <- get_distribution_surveillance(data_other_viruses,
                              include_sars = TRUE,
                              surveillance_type = "irag_inusitado")

irag_inusitado_distribution <- irag_inusitado_distribution %>% arrange(grupo_edad)

plot_irag_inusitado <- plot_distribution_age_group(irag_inusitado_distribution, include_sars = TRUE)

# datos_convertidos <- tidyr::spread(irag_inusitado_distribution, key = grupo_edad, value = casos:etiqueta)
# 
# tabla <- gridExtra::tableGrob(irag_inusitado_distribution, theme = gridExtra::ttheme_default(base_size = 10))

plot_irag_inusitado

# gridExtra::grid.arrange(plot_irag_inusitado, tabla, ncol = 1, heights = c(2, 1))
```

En la figura 4 se puede observar el comportamiento de los virus identificados tanto por la vigilancia centinela como por la vigilancia del IRAG inusitado, mediante las dos metodologías: inmunofluorescencia y RT-PCR.

En las semanas transcurridas de 2022 se aprecia la positividad para cualquier virus respiratorio, diferentes al SARS-CoV-2, en la siguiente tabla.

**Figura 4. Circulación de virus respiratorios en casos de IRAG identificados por inmunofluorescencia y prueba molecular, Laboratorio de Salud Pública.** 

```{r distribution_test, echo=FALSE, error=FALSE, fig.height=7, fig.width=12, warning=FALSE, include=TRUE, message=FALSE}
test_distribution_epiweek <- get_distribution_test(data_other_viruses,
                              include_sars = FALSE)
plot_test <- plot_distribution_epiweek(test_distribution_epiweek, 
                            var_x = "semanaepidemiologicavegeneral",
                            var_y = "casos",
                            var_fill = "etiqueta")

cases_epiweeks <- get_cases_epiweeks(test_distribution_epiweek)

plot_cases <- plot_test + 
  ggplot2::geom_line(ggplot2::aes_string(x =
                                           "semanaepidemiologicavegeneral",
                                         y = "casos"),
                     stat = "identity",
                     color = "#F99D00",
                     size = 1,
                     group = 1) +
  ggplot2::scale_y_continuous(sec.axis =
                                ggplot2::sec_axis(~.*.0055, labels =
                                                    scales::percent_format(),
                                                  breaks = seq(0, 1, .1)))

plot_cases

```

\newpage

**Tabla 1. Positividad de virus respiratorios por semana epidemiológica, Bogotá 2022 ** 

```{r distribution_cases_epiweek, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
distribution_epiweek <- get_cases_epiweeks(test_distribution_epiweek,
                                           table = TRUE)
knitr::kable(distribution_epiweek)
```

Dentro de la circulación viral predominan los VSR (19 %), rinovirus (20 %), bocavirus (9 %), adenovirus (18 %), parainfluenza (9 %) y virus de influenza A H3N2 (10 %), en las 9.184 muestras analizadas (figura 5).


**Figura 5. Proporción acumulada de los virus respiratorios, Laboratorio de Salud Pública**

```{r cumulative_proportion, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
viruses_cumulative_proportion <- get_viruses_cumulative_proportion(viruses_age_group,                                                               test_distribution_epiweek)
plot_cumulative_proportion(viruses_cumulative_proportion)
```

En cuanto al comportamiento de los virus de influenza, estos circularon durante las seis primeras semanas del año, siendo el subtipo H3N1 el predominante (figura 6); este mismo subtipo reaparece en la semana 12 con tres casos y vuelve a mostrase desde la semana 17 de forma continua hasta la semana 52, alcanzando una positividad de 0,0 % en esta semana entre todos los virus.

**Figura 6. Distribución de tipos y subtipos de Influenza, Laboratorio de Salud Pública**

```{r distribution_influeza, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
distribution_influenza <- get_distribution_influenza(data_other_viruses, report_data_clean)
plot_distribution_influenza <- 
  plot_distribution_epiweek(distribution_influenza,
                            var_x = "semanaepidemiologicavegeneral",
                            var_y = "casos",
                            var_fill = "etiqueta",
                            influenza = TRUE)
plot_distribution_influenza
```

# Tosferina

El Laboratorio de Salud Pública también apoya la vigilancia de tosferina, con el análisis de todos los 
casos probables que se presenten en la ciudad. El análisis de la muestra se realiza mediante PCR 
Multiplex, que en tiempo real detecta Bordetella pertussis, Bordetella parapertussis y Bordetella 
holmesii.

Se ha observado la siguiente positividad en 1.060 muestras analizadas:

**Tabla 2.** Positividad de tosferina por semana epidemiológica, Bogotá 2022

```{r tosferina_epiweek, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
tosferina_data <- import_data_viral_circulation(report_data = c("C:/Users/geral/Documents/TRACE/labrep/data/df_tosferina_202252.csv"), header = TRUE)
cases_epiweeks_tosferina <- get_cases_tosferina(tosferina_data)
table_epiweek <- get_table_epiweek_tosferina(cases_epiweeks_tosferina)
knitr::kable(table_epiweek)
  
```

El comportamiento de la tosferina por grupo de edad indica que el 30.6 % de las muestras 
recibidas pertenecen al grupo de niños menores de un mes, seguido del grupo de niños de 2 a 
3 meses, con el 32.0 % (figura 8).

**Figura 5.** Comportamiento de la positividad de tosferina en las muestras recibidas por el Laboratorio de Salud Pública 2022

```{r distribution_tosferina_epiweek, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}
results_epiweeks_tosferina <- get_results_tosferina(tosferina_data)
plot_results_tosferina(results_epiweeks_tosferina, cases_epiweeks_tosferina) 
```

**Figura 6.** Distribución porcentual de casos de tosferina confirmados en el Laboratorio de Salud Pública por grupo de edad

```{r distribution_tosferina_ages, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}

group_ages_tosferina <- get_cases_tosferina(tosferina_data, column = "grupo_edad")
results_ages_tosferina <- get_results_tosferina(tosferina_data, columns =  c("grupo_edad", "interpretacion_del_resultado"))
plot_results_tosferina(results_ages_tosferina, 
                       group_ages_tosferina, 
                       column = "grupo_edad",
                       stack_line = FALSE,
                       label_x = "Grupo de edad")
```

Con respecto al género, se observa que el 100% de los casos positivos corresponden al género femenino (figura 9). 

**Figura 7.** Distribución porcentual de casos de tosferina confirmados en el Laboratorio de Salud Pública según género

```{r distribution_tosferina_sex, echo=FALSE, error=FALSE, fig.height=5, fig.width=10, warning=FALSE, include=TRUE, message=FALSE}

results_sex_tosferina <- get_results_tosferina(tosferina_data, columns =  c("genero", "interpretacion_del_resultado"))
plot_results_tosferina(results_sex_tosferina, 
                       column = "genero",
                       label_x = "Genero", 
                       stack_line = FALSE,
                       show_values = FALSE)
```
